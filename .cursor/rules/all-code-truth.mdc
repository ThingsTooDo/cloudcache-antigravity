---
scope: ["**/*"]
enforce: true
---
# All Code Truth

## Documentation Truth

Each truth file must stay in lock‑step with the code and scripts listed below. When any process or script changes, update the corresponding truth doc and add an entry to this MDC file.

- **`docs/all-system-truth.md`** – Defines the Golden Path, ownership model, and script manifest. Includes a table that maps every active shell script to its purpose and authoritative documentation.
- **`docs/all-git-truth.md`** – Covers commit policies, hook behavior, the `scripts/all-git-truth.sh` utility (`--pre-commit`, `--validate-md`, `--git-safe`), and mitigation steps for EPERM or lint-staged failures.
- **`docs/all-deployment-truth.md`** – Canonical reference for deploying individual modules or the full stack. Documents preview/staging URLs, health endpoints, and validation/verification commands.
- **`docs/all-local-dev-truth.md`** – Explains local bindings (`.dev.vars`), local ports, `pnpm dev:*` flows, and troubleshooting steps (cache resets, `scripts/dev-local.sh`, etc.).

### Supporting Guides (link up to the truth docs)

- **`docs/operational-runbook.md`** – Monitoring, incident response, and alert flows (canonical: deployment truth).
- **`docs/secrets-management.md`** – Secret rotation strategy, Wrangler bindings, and disaster-recovery steps (canonical: local-dev truth).
- **`docs/shopify-oauth-setup.md`** – OAuth scopes, callback configuration, and validation for the App worker (canonical: deployment truth).
- **`docs/zero-trust/support-bundle.md`** – Template for Cloudflare support tickets with required evidence (canonical: system truth).
- **`docs/zero-trust/tokens.md`** – Procedures for creating, rotating, and auditing Zero Trust tokens (canonical: system truth).

Every supporting guide must include:
1. The standard header block (Last Updated, Rule Reference, Canonical Source).
2. A short “When to use this guide” blurb linking back up to the relevant truth file.

## Script Truth  
- **Git Operations**: `scripts/all-git-truth.sh` - Unified git wrapper and pre-commit hook.
- **Deployment**: `scripts/deploy-module.sh` - Master script for single-module deployment.
- **Preview**: `scripts/deploy-preview.sh` - Wrapper to deploy all modules to preview.
- **Validation**: `scripts/validation/run-validation.sh` - Automated deployment testing suite.

## Script Truth  
- **`scripts/all-git-truth.sh`** – Unified git wrapper (pre-commit formatting/validation, markdown structure validation, credential-safe git commands). This script is the enforcement point for documentation rules (`--validate-md`).
- **`scripts/deploy-module.sh`** – Master script for single-module deployments (respects retries/backoff and environment validation).
- **`scripts/deploy-preview.sh`** – Orchestrates preview deployments for all modules; wraps `deploy-module.sh`.
- **`scripts/validation/run-validation.sh`** – Automated deployment test suite (local + remote health checks).
- **`scripts/dev-local.sh` / `scripts/dev-stop.sh`** – Sequential local server startup with health checks and cleanup.
Each script referenced above must be documented in `docs/all-system-truth.md`’s manifest section.

## File Naming Convention (ENFORCED)
- **Lowercase only**: no uppercase letters allowed
- **Hyphen-separated**: use hyphens, not underscores
- **"all-" prefix**: reserved for truth/index files only
- **Examples**: 
  - ✅ `all-git-truth.md`, `deploy-module.sh`, `api-helpers.ts`
  - ❌ `Deploy_Module.sh`, `API-HELPERS.ts`, `Quick-Fix-GUIDE.md`

## MD File Creation Rules

### Placement
- **Documentation**: `docs/` or domain-specific subdirectories (e.g., `docs/zero-trust/`)
- **Truth Files**: `docs/all-<domain>-truth.md`
- **Archives**: `docs/archive/` (never delete, always archive)

### Required Headers (Templates)

**1. Truth File Template** (`docs/all-*-truth.md`)
```markdown
# <Domain> Truth

**Last Updated**: YYYY-MM-DD  
**Rule Reference**: `.cursor/rules/all-code-truth.mdc`  
**Related**: `docs/all-system-truth.md`
```

**2. Supporting Guide Template** (`docs/operational-runbook.md`, etc.)
```markdown
# <Guide Title>

**Last Updated**: YYYY-MM-DD  
**Rule Reference**: `.cursor/rules/all-code-truth.mdc`  
**Canonical Source**: `docs/all-<domain>-truth.md`
```

**3. Archive Header**
```markdown
# [Original Title]

**DEPRECATED**: This file has been consolidated.  
**See**: `docs/all-<domain>-truth.md`

**Migration Date**: YYYY-MM-DD
**Archived On**: YYYY-MM-DD HH:MM:SS

---
```

### Interlinking
- Every MD file must reference `.cursor/rules/all-code-truth.mdc`
- Domain-specific files must reference their `all-<domain>-truth.md`
- Truth files must reference each other where relevant

### Grouping
- **Domain Truth**: One `all-<domain>-truth.md` per major area (Git, Deployment, API)
- **Child Files**: Specific guides link UP to the domain truth file
- **Index**: `docs/all-system-truth.md` lists all truth files

### Generated Content & Archives
- **Auto-generated reports** under `docs/reports/validation/` are exempt from header requirements but must never be committed manually. The pre-commit check unstages them automatically.
- **Archives** (`docs/archive/**`, `scripts/archive/**`) must use the archive header template above. Each archived file has to specify the migration date and the active replacement document.
- When deprecating a file:
  1. Move it under `docs/archive/` (or `scripts/archive/`).
  2. Add the archive header block with migration metadata and the pointer to the replacement truth doc.
  3. Update the relevant truth doc to mention the archive if historical knowledge is still useful.

## Plan File Rules
- **Location**: All new plans must be created under `docs/plans/`.
- **Naming**: Use user-provided filename (lowercase, hyphen-separated).
- **Prohibited**: 
  - Never create or use `one.plan.md`.
  - Do not write plans to repository root or `.cursor/`.
- **Correction**: If a plan is accidentally generated elsewhere, move it to `docs/plans/<name>.md` immediately.

## MDC (Rule) File Creation Rules

### Placement
- **Location**: `.cursor/rules/`
- **Extension**: `.mdc`

### Naming
- **Format**: `all-<domain>-truth.mdc` (for consolidated rules) or `<specific-rule>.mdc`
- **Convention**: Lowercase, hyphen-separated

### Structure
- **Frontmatter**: Must include `scope` and `enforce` fields
- **Content**: Clear, actionable rules (no fluff)
- **References**: Must link to corresponding `docs/all-<domain>-truth.md`

## Governance & Drift Prevention
- Run `bash scripts/all-git-truth.sh --pre-commit` before every commit (already wired into Husky).
- Run `bash scripts/all-git-truth.sh --validate-md` after editing documentation to ensure filenames, headers, and references follow this MDC.
- Files flagged by `--validate-md` must be corrected in the same change that introduced the regression.
- Automated or temporary files (validation reports, logs) must never be staged; rely on the pre-commit script to enforce this.

## Deprecated Patterns (BANNED)
- `one.plan.md` - never create or use
- Uppercase in filenames - convert to lowercase
- Underscore separators - convert to hyphens (except DB migrations)
- Multiple truth files per domain - consolidate to one
- **Pages.dev**: Do not introduce `pages.dev` references or `wrangler pages` commands. Prefer staging subdomains (`staging-apex|app|admin.cloudcache.ai`).
