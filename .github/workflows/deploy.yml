# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Deploy
on:
  push:
    branches: [main]

permissions:
  contents: read
  id-token: write

env:
  ENABLE_DEPLOY: ${{ vars.ENABLE_DEPLOY || 'true' }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
  deploy:
    if: ${{ env.ENABLE_DEPLOY != 'false' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node and PNPM
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: '22'
          pnpm-version: '9'

      - run: pnpm install --frozen-lockfile=false

      - name: Determine changed packages
        id: changed
        run: |
          set -euo pipefail
          BEFORE_SHA="${{ github.event.before }}"
          if [ -z "$BEFORE_SHA" ]; then
            BEFORE_SHA="$(git rev-parse HEAD^)"
          fi
          CHANGED=$(git diff --name-only "$BEFORE_SHA" "${{ github.sha }}" | grep '^src/' | cut -d/ -f2 | sort -u | tr '\n' ' ' || true)
          echo "changed=$CHANGED" >> "$GITHUB_OUTPUT"

      - name: No changes
        if: steps.changed.outputs.changed == ''
        run: echo "No worker changes detected."

      - name: Deploy changed workers
        if: steps.changed.outputs.changed != ''
        run: |
          set -euo pipefail
          for pkg in ${{ steps.changed.outputs.changed }}; do
            echo "Deploying $pkg"
            bash scripts/deploy.sh "$pkg" production
          done

      - name: Summary
        run: |
          {
            echo "### Deploy toggles";
            echo "- ENABLE_DEPLOY=${{ env.ENABLE_DEPLOY }}";
          } >> "$GITHUB_STEP_SUMMARY"


