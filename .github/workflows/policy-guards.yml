# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Policy Guards
on:
  pull_request:

jobs:
  ban-pages-dev:
    if: ${{ vars.ENABLE_POLICY_GUARDS != 'false' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Fail on pages.dev or wrangler pages references in code
        run: |
          set -euo pipefail
          dirs=(src scripts packages .github)
          hits=""
          for d in "${dirs[@]}"; do
            if [ -d "$d" ]; then
              part=$(grep -RInE "pages\.dev|wrangler pages" "$d" || true)
              hits="$hits$part\n"
            fi
          done
          if [ -n "$(echo "$hits" | sed '/^$/d')" ]; then
            echo -e "Found disallowed references in code paths:\n$hits" >&2
            exit 1
          fi
          echo "No disallowed references found in code paths."
      - name: Summary (pages-dev)
        run: |
          {
            echo "### Policy Guards toggles";
            echo "- ENABLE_POLICY_GUARDS=${{ vars.ENABLE_POLICY_GUARDS || 'true' }}";
          } >> "$GITHUB_STEP_SUMMARY"

  guard-plan-location:
    if: ${{ vars.ENABLE_POLICY_GUARDS != 'false' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Block one.plan.md and plans outside docs/plans/
        run: |
          set -euo pipefail
          bad=""
          x=$(git ls-files | grep -E '^one\.plan\.md$|/one\.plan\.md$' || true)
          [ -n "$x" ] && bad="$bad$x\n"
          y=$(git ls-files | grep -Ei '\\.(md|mdc)$' | grep -Ei 'plan' | grep -v '^docs/plans/' || true)
          [ -n "$y" ] && bad="$bad$y\n"
          if [ -n "$(echo -e "$bad" | sed '/^$/d')" ]; then
            echo -e "Plan location violations:\n$bad" >&2
            exit 1
          fi
          echo "Plan location guard passed."
      - name: Summary (plan-location)
        run: |
          {
            echo "### Policy Guards toggles";
            echo "- ENABLE_POLICY_GUARDS=${{ vars.ENABLE_POLICY_GUARDS || 'true' }}";
          } >> "$GITHUB_STEP_SUMMARY"
      - name: Save run report
        if: always()
        run: |
          {
            echo "repo=${{ github.repository }}";
            echo "sha=${{ github.sha }}";
            echo "workflow=${{ github.workflow }}";
            echo "run_number=${{ github.run_number }}";
            echo "enable_policy_guards=${{ vars.ENABLE_POLICY_GUARDS || 'true' }}";
          } > run-report.txt
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Policy-Guards-run-${{ github.run_number }}
          path: run-report.txt
          retention-days: 14


