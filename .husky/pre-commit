#!/usr/bin/env sh

# Staged-only, fast checks
# Suppress url.parse() deprecation warning from dependencies
# Handle EPERM and other permission errors gracefully

# Store the exit code but don't fail immediately
set +e

# Prevent committing IDE-specific files
IDE_FILES=$(git diff --cached --name-only | grep -E '^\.(cursor|antigravity|vscode)/')
if [ -n "$IDE_FILES" ]; then
  echo "❌ ERROR: Attempting to commit IDE-specific files:"
  echo "$IDE_FILES"
  echo "These files should be gitignored. Update .gitignore."
  exit 1
fi

# Run consolidated pre-commit checks
bash scripts/all-git-truth.sh --pre-commit
PRE_COMMIT_EXIT=$?

# If pre-commit failed, check if it's a permission error
if [ $PRE_COMMIT_EXIT -ne 0 ]; then
  echo ""
  echo "⚠️  Pre-commit hooks encountered an issue (exit code: $PRE_COMMIT_EXIT)"
  echo ""
  echo "Common fixes:"
  echo "  1. Run: pnpm install (to fix node_modules permissions)"
  echo "  2. Run: bash scripts/all-git-truth.sh --pre-commit (manual check)"
  echo "  3. If urgent: git commit --no-verify (skip hooks, use with caution)"
  echo ""
  exit $PRE_COMMIT_EXIT
fi

exit 0
