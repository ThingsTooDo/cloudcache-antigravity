#!/usr/bin/env sh

# Staged-only, fast checks
# Suppress url.parse() deprecation warning from dependencies
# Handle EPERM and other permission errors gracefully

# Store the exit code but don't fail immediately
set +e

NODE_OPTIONS="--no-deprecation" pnpm dlx lint-staged
LINT_STAGED_EXIT=$?

# If lint-staged failed, check if it's a permission error
if [ $LINT_STAGED_EXIT -ne 0 ]; then
  echo ""
  echo "⚠️  Pre-commit hooks encountered an issue (exit code: $LINT_STAGED_EXIT)"
  echo ""
  echo "Common fixes:"
  echo "  1. Run: pnpm install (to fix node_modules permissions)"
  echo "  2. Run: bash scripts/pre-commit-check.sh (manual pre-commit check)"
  echo "  3. If urgent: git commit --no-verify (skip hooks, use with caution)"
  echo ""
  exit $LINT_STAGED_EXIT
fi

exit 0
