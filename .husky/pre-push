#!/usr/bin/env sh

# Lint GitHub workflows if actionlint is available
if command -v actionlint >/dev/null 2>&1; then
  actionlint || { echo "actionlint failed"; exit 1; }
else
  echo "actionlint not installed; skipping"
fi

# TypeScript sanity (no emit)
if command -v pnpm >/dev/null 2>&1; then
  # Check if TypeScript is installed by looking for the binary file
  if [ -f "node_modules/.bin/tsc" ]; then
    # Binary exists - verify pnpm can execute it (catches permission/env issues)
    if pnpm exec tsc --version >/dev/null 2>&1; then
      # TypeScript is installed and executable, run typecheck - fail on any error
      pnpm exec tsc -p tsconfig.base.json --noEmit || {
        echo "Typecheck failed"; exit 1;
      }
    else
      # Binary exists but pnpm can't execute it - this indicates an environment problem
      echo "TypeScript binary found but pnpm exec failed - environment issue detected"
      exit 1
    fi
  else
    # Binary doesn't exist - TypeScript is not installed, skip gracefully
    echo "TypeScript not installed; skipping typecheck"
  fi
else
  echo "pnpm not available; skipping typecheck"
fi

# Optional secrets scan
if command -v gitleaks >/dev/null 2>&1; then
  gitleaks protect --no-banner --staged --redact || {
    echo "Secrets scan failed"; exit 1;
  }
else
  echo "gitleaks not installed; skipping"
fi

