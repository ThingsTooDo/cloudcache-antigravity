name = "app-worker"
main = "dist/index.js"
compatibility_date = "2025-10-07"

# Production routes
routes = [
  { pattern = "app.cloudcache.ai/*", zone_name = "cloudcache.ai" }
]

# Remote bindings for local dev (no .dev.vars needed)
# Note: remote bindings are enabled by default in Wrangler v4
[dev]
port = 8789

# Production KV namespace (keep current ID)
[[kv_namespaces]]
binding = "APP_KV"
id = "5df224d061fb4f869a1a713f1ebd7252"

# Durable Objects - WebSocket hub for real-time toggle sync
[durable_objects]
bindings = [
  { name = "TOGGLE_HUB", class_name = "ToggleHub" }
]

# Durable Object migrations (use new_sqlite_classes for free plans)
[[migrations]]
tag = "v1"
new_sqlite_classes = ["ToggleHub"]

# Cron triggers for background sync and PageSpeed updates
[triggers]
crons = ["*/5 * * * *", "0 6,18 * * *"]

# Staging environment
[env.staging]
name = "app-worker-staging"
routes = [
  { pattern = "staging-app.cloudcache.ai/*", zone_name = "cloudcache.ai" }
]

[[env.staging.kv_namespaces]]
binding = "APP_KV"
id = "5df224d061fb4f869a1a713f1ebd7252"

[env.staging.durable_objects]
bindings = [
  { name = "TOGGLE_HUB", class_name = "ToggleHub" }
]

# Preview environment
[env.preview]
name = "app-worker-preview"
# Preview has no routes - uses workers.dev subdomain
routes = []
workers_dev = true

[[env.preview.kv_namespaces]]
binding = "APP_KV"
id = "58050e98476b42578f917f32582b6647"

[env.preview.durable_objects]
bindings = [
  { name = "TOGGLE_HUB", class_name = "ToggleHub" }
]
